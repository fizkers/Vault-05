<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VAULT-OS | MASTER SYSTEM</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap');
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: #050505; color: #00ff41; font-family: 'Fira Code', monospace; margin: 0; padding: 10px; display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow-x: hidden; }
        
        .main-layout { display: grid; grid-template-columns: 2.5fr 1fr; gap: 15px; width: 100%; max-width: 1200px; height: 90vh; }
        .terminal-container { background: #0d0d0d; border: 1px solid #1a1a1a; border-radius: 12px; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.5); overflow: hidden; }
        .terminal-header { background: #1a1a1a; padding: 12px; display: flex; align-items: center; justify-content: center; position: relative; flex-shrink: 0; }
        .buttons { display: flex; gap: 6px; position: absolute; left: 15px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }
        .red { background: #ff5f56; } .yellow { background: #ffbd2e; } .green { background: #27c93f; }
        .title { color: #666; font-size: 10px; letter-spacing: 1px; text-transform: uppercase; }

        .terminal-body { padding: 15px; overflow-y: auto; font-size: 13px; flex-grow: 1; scrollbar-width: none; }
        .terminal-body::-webkit-scrollbar { display: none; }

        .auth-box { max-width: 400px; margin: auto; width: 100%; }
        .input-line { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; border-bottom: 1px solid #1a1a1a; padding-bottom: 5px; }
        .input-line span { color: #666; font-size: 10px; width: 70px; }
        input { background: transparent; border: none; color: #fff; font-family: 'Fira Code'; outline: none; width: 100%; font-size: 14px; }
        
        .term-btn { flex: 1; background: transparent; border: 1px solid #00ff41; color: #00ff41; padding: 10px; cursor: pointer; font-family: 'Fira Code'; font-size: 11px; border-radius: 4px; transition: 0.2s; }
        .term-btn:hover { background: #00ff41; color: #000; }

        .sidebar { display: flex; flex-direction: column; gap: 15px; height: 100%; }
        .sidebar-box { flex: 1; min-height: 180px; }
        #chat-box, #leaderboard-box { font-size: 11px; line-height: 1.6; }
        .chat-in { padding: 12px; background: #080808; border-top: 1px solid #1a1a1a; font-size: 12px; border-radius: 0; }

        .highlight { color: #fff; text-shadow: 0 0 5px #00ff41; }
        .command-line { display: flex; align-items: center; padding-top: 10px; }
        .prompt { color: #00ff41; margin-right: 10px; font-weight: bold; }

        pre { font-size: 8px; line-height: 1.2; color: #00ff41; margin: 10px 0; }

        @media (max-width: 900px) { 
            .main-layout { grid-template-columns: 1fr; height: auto; display: block; } 
            .terminal-container { margin-bottom: 15px; height: 450px; } 
            .sidebar-box { height: 250px; } 
            body { overflow-y: auto; display: block; padding: 10px; }
            pre { font-size: 5px; }
        }
    </style>
</head>
<body>
    <audio id="sound-success" src="https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3" preload="auto"></audio>
    <audio id="sound-money" src="https://assets.mixkit.co/active_storage/sfx/1614/1614-preview.mp3" preload="auto"></audio>

    <div id="login-screen" class="terminal-container auth-box">
        <div class="terminal-header">
            <div class="buttons"><span class="dot red"></span><span class="dot yellow"></span><span class="dot green"></span></div>
            <div class="title">VAULT SECURE ACCESS</div>
        </div>
        <div class="terminal-body">
            <div class="input-line"><span>USER</span><input type="text" id="login-user" autocomplete="off"></div>
            <div class="input-line"><span>PASS</span><input type="password" id="login-pass"></div>
            <div id="reg-fields" style="display:none;"><div class="input-line"><span>RE-PASS</span><input type="password" id="reg-pass-confirm"></div></div>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button id="btn-login" class="term-btn">LOGIN</button>
                <button id="btn-reg-toggle" class="term-btn">SIGN UP</button>
                <button id="btn-reg-final" class="term-btn" style="display:none;">CREATE</button>
            </div>
        </div>
    </div>

    <div id="main-app" style="display:none; width: 100%; max-width: 1200px;">
        <div class="main-layout">
            <div class="terminal-container">
                <div class="terminal-header">
                    <div class="buttons"><span class="dot red"></span><span class="dot yellow"></span><span class="dot green"></span></div>
                    <div class="title">TERMINAL@VAULT — <span id="display-id" style="color:#ffbd2e"></span></div>
                </div>
                <div class="terminal-body" id="term-scroll">
                    <div id="history"></div>
                    <div class="command-line">
                        <span class="prompt">$</span>
                        <input type="text" id="user-input" autofocus autocomplete="off" spellcheck="false" enterkeyhint="send">
                    </div>
                </div>
            </div>
            <div class="sidebar">
                <div class="terminal-container sidebar-box"><div class="terminal-header"><div class="title">NETWORK TRAFFIC</div></div><div class="terminal-body"><canvas id="txChart"></canvas></div></div>
                <div class="terminal-container sidebar-box"><div class="terminal-header"><div class="title">ENCRYPTED CHAT</div></div><div class="terminal-body" id="chat-box"></div><input type="text" id="chat-input" placeholder="Secure message..." class="chat-in" enterkeyhint="send"></div>
                <div class="terminal-container sidebar-box"><div class="terminal-header"><div class="title">VAULT RANK</div></div><div class="terminal-body" id="leaderboard-box"></div></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, push, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDZe0QP2l2nAjw6qeYUE9wkryMTAnC6N_0",
            authDomain: "vault-blockchain.firebaseapp.com",
            databaseURL: "https://vault-blockchain-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "vault-blockchain",
            storageBucket: "vault-blockchain.firebasestorage.app",
            messagingSenderId: "297566281394",
            appId: "1:297566281394:web:b7b7257551dfe5f69bb3ab"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let user = { name: "", id: "", balance: 0, is_frozen: false };
        let txChart;
        let miningInterval = null;

        const formatN = (num) => Number(num).toLocaleString('id-ID');
        const playSound = (id) => document.getElementById(id).play().catch(()=>{});
        const scrollBottom = () => { const area = document.getElementById('term-scroll'); area.scrollTop = area.scrollHeight; };

        const showLoading = (hist) => {
            return new Promise((resolve) => {
                let pct = 0; const line = document.createElement('div'); hist.appendChild(line);
                const inv = setInterval(() => {
                    pct += 10; line.innerHTML = `<span style="color:#ffbd2e">SYNCING: [${'#'.repeat(pct/10)}${'.'.repeat(10-pct/10)}] ${pct}%</span>`;
                    scrollBottom(); if (pct >= 100) { clearInterval(inv); line.innerHTML = `<span style="color:#00ff41">BROADCAST SUCCESS.</span>`; resolve(); }
                }, 100);
            });
        };

        // --- LOGO ASCII ---
        const printLogo = () => {
            const logo = `
██╗   ██╗ █████╗ ██╗   ██╗██╗     ████████╗
██║   ██║██╔══██╗██║   ██║██║     ╚══██╔══╝
██║   ██║███████║██║   ██║██║        ██║   
╚██╗ ██╔╝██╔══██║██║   ██║██║        ██║   
 ╚████╔╝ ██║  ██║╚██████╔╝███████╗   ██║   `;
            document.getElementById('history').innerHTML += `<pre>${logo}</pre>
            <p style="color:#ffbd2e">USER: ${user.name} | ID: ${user.id}</p><hr style="border-top:1px dashed #222">`;
        };

        // --- AUTH ---
        document.getElementById('btn-reg-toggle').onclick = () => { document.getElementById('reg-fields').style.display = 'block'; document.getElementById('btn-login').style.display = 'none'; document.getElementById('btn-reg-toggle').style.display = 'none'; document.getElementById('btn-reg-final').style.display = 'block'; };

        document.getElementById('btn-reg-final').onclick = async () => {
            const lock = localStorage.getItem('vault_user_lock');
            if(lock) return alert("Device Lock!");
            const u = document.getElementById('login-user').value.trim();
            const p = document.getElementById('login-pass').value;
            if(!u || p !== document.getElementById('reg-pass-confirm').value) return alert("Error!");
            const newID = "VLT-" + Math.random().toString(36).substring(2, 6).toUpperCase();
            await set(ref(db, 'users/' + u), { password: p, id: newID, balance: 0, device_locked: true, is_frozen: false });
            localStorage.setItem('vault_user_lock', u); location.reload();
        };

        document.getElementById('btn-login').onclick = async () => {
            const u = document.getElementById('login-user').value.trim();
            const p = document.getElementById('login-pass').value;
            const snap = await get(ref(db, 'users/' + u));
            if(snap.exists() && snap.val().password === p) {
                const lock = localStorage.getItem('vault_user_lock');
                if (snap.val().device_locked && lock && lock !== u) return alert("Device Locked!");
                localStorage.setItem('vault_user_lock', u); user = { name: u, ...snap.val() };
                document.getElementById('login-screen').style.display = 'none'; document.getElementById('main-app').style.display = 'block'; initSystem();
            } else { alert("Akses Ditolak!"); }
        };

        function initSystem() {
            document.getElementById('display-id').innerText = user.id;
            printLogo();
            const ctx = document.getElementById('txChart').getContext('2d');
            txChart = new Chart(ctx, { type: 'line', data: { labels: [], datasets: [{ data: [], borderColor: '#00ff41', borderWidth: 2, pointRadius: 0, fill: true, backgroundColor: 'rgba(0, 255, 65, 0.1)', tension: 0.4 }] }, options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false},y:{beginAtZero:true, ticks:{color:'#333', font:{size:8}}}} } });
            
            onValue(ref(db, 'users'), (snap) => {
                const all = snap.val(); if(!all) return;
                const sorted = Object.entries(all).map(([n, d]) => ({ n, b: d.balance })).sort((a,b)=>b.b-a.b);
                document.getElementById('leaderboard-box').innerHTML = sorted.map((u,i)=> `<div>#${i+1} ${u.n} <span style="float:right">${formatN(u.b)}</span></div>`).join('');
                
                // --- SENYAP SAAT MINING ---
                if(user.balance < all[user.name].balance && user.balance !== 0 && !miningInterval) {
                    playSound('sound-money');
                }
                user.balance = all[user.name].balance; user.is_frozen = all[user.name].is_frozen;
            });

            onValue(ref(db, 'blockchain'), (snap) => {
                const txs = Object.values(snap.val() || {}).slice(-15);
                txChart.data.labels = txs.map(t => t.time); txChart.data.datasets[0].data = txs.map(t => t.amt); txChart.update();
            });

            onValue(ref(db, 'messages'), (snap) => {
                const cb = document.getElementById('chat-box'); cb.innerHTML = Object.values(snap.val() || {}).map(x=>`<div><span style="color:#ffbd2e">${x.user}</span>: ${x.text}</div>`).join(''); cb.scrollTop = cb.scrollHeight;
            });
            scrollBottom();
        }

        document.getElementById('user-input').addEventListener('keydown', async function(e) {
            if(e.key === 'Enter') {
                e.preventDefault(); const input = this.value.trim(); const pts = input.split(' '); const cmd = pts[0].toLowerCase();
                const hist = document.getElementById('history'); if(!input) return;
                hist.innerHTML += `<div><span style="color:#444">$</span> ${input}</div>`; this.value = "";

                if (cmd === 'help') {
                    hist.innerHTML += `<div style="color:#00ff41; font-size:11px; margin:5px 0; border:1px solid #222; padding:5px;">
                        <p>> balance | clear | transfer [ID] [AMT]</p>
                        ${user.name === "MasterHafiz" ? `<p style="color:#ff5f56">> mine start/stop | deposit [AMT] | /freeze [user] | /unfreeze [user] | sudo_reset_user [user] | logout_force</p>` : ""}
                    </div>`;
                }
                else if(cmd === 'balance') hist.innerHTML += `<p>WALLET: <span class="highlight">${formatN(user.balance)}</span></p>`;
                else if(cmd === 'clear') hist.innerHTML = "";
                else if(cmd === 'logout_force') { await showLoading(hist); localStorage.removeItem('vault_user_lock'); location.reload(); }
                else if(cmd === 'transfer') {
                    if(user.is_frozen) { hist.innerHTML += `<p style="color:red">ERROR: ACCOUNT FROZEN.</p>`; return; }
                    const idT = pts[1]; const amt = parseFloat(pts[2]);
                    const snap = await get(ref(db, 'users'));
                    const target = Object.entries(snap.val()).find(([n, d]) => d.id === idT);
                    if(target && amt > 0 && amt <= user.balance) {
                        await showLoading(hist);
                        await update(ref(db, `users/${user.name}`), { balance: user.balance - amt });
                        await update(ref(db, `users/${target[0]}`), { balance: target[1].balance + amt });
                        push(ref(db, 'blockchain'), { amt, time: new Date().toLocaleTimeString() });
                        playSound('sound-success');
                    } else { hist.innerHTML += `<p style="color:red">ERR: DATA INVALID.</p>`; }
                }
                else if(user.name === "MasterHafiz") {
                    const targetU = pts[1];
                    if(cmd === 'mine') {
                        if(pts[1] === 'start') {
                            if(!miningInterval) miningInterval = setInterval(() => update(ref(db, `users/${user.name}`), { balance: user.balance + 0.1 }), 5000);
                            hist.innerHTML += `<p style="color:cyan">[SYSTEM] AUTO-MINING: ON (SILENT MODE)</p>`;
                        } else { clearInterval(miningInterval); miningInterval = null; hist.innerHTML += `<p style="color:red">[SYSTEM] AUTO-MINING: OFF</p>`; }
                    }
                    else if(cmd === 'deposit' && pts[1]) { 
                        await showLoading(hist); 
                        update(ref(db, `users/${user.name}`), { balance: user.balance + parseFloat(pts[1]) }); 
                    }
                    else if(cmd === '/freeze' && targetU) {
                        update(ref(db, `users/${targetU}`), { is_frozen: true }).then(() => { hist.innerHTML += `<p style="color:red">[OK] ${targetU} LOCKED.</p>`; });
                    }
                    else if(cmd === '/unfreeze' && targetU) {
                        update(ref(db, `users/${targetU}`), { is_frozen: false }).then(() => { hist.innerHTML += `<p style="color:#00ff41">[OK] ${targetU} ACTIVE.</p>`; });
                    }
                    else if(cmd === 'sudo_reset_user' && targetU) {
                        update(ref(db, `users/${targetU}`), { device_locked: false });
                        hist.innerHTML += `<p style="color:orange">[OK] ${targetU} DEVICE RESET.</p>`;
                    }
                }
                scrollBottom();
            }
        });

        document.getElementById('chat-input').addEventListener('keydown', function(e) {
            if(e.key === 'Enter' && this.value) { push(ref(db, 'messages'), { user: user.name, text: this.value }); this.value = ""; }
        });
    </script>
</body>
</html>
