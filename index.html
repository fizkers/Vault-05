<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VAULT-05 | NEON SECURE OS</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap');
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        /* Layout Utama Fix */
        body { 
            background: #020205; color: #00ff41; font-family: 'Fira Code', monospace; 
            margin: 0; padding: 10px; display: flex; justify-content: center; align-items: center; 
            height: 100vh; height: 100dvh; overflow: hidden; 
        }
        
        #main-app { width: 100%; max-width: 1200px; height: 100%; display: flex; flex-direction: column; }
        .main-layout { 
            display: grid; grid-template-columns: 2.5fr 1fr; gap: 15px; width: 100%; height: 100%; min-height: 0; 
        }

        .terminal-container { 
            background: rgba(13, 13, 20, 0.95); border: 1px solid #1a1a2e; border-radius: 12px; 
            display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0, 255, 65, 0.1); 
            overflow: hidden; min-height: 0; 
        }

        .terminal-header { 
            background: #161625; padding: 12px; display: flex; align-items: center; 
            justify-content: center; position: relative; border-bottom: 1px solid #1a1a2e; flex-shrink: 0;
        }

        .buttons { display: flex; gap: 6px; position: absolute; left: 15px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }
        .red { background: #ff5f56; box-shadow: 0 0 5px #ff5f56; } 
        .yellow { background: #ffbd2e; box-shadow: 0 0 5px #ffbd2e; } 
        .green { background: #27c93f; box-shadow: 0 0 5px #27c93f; }
        .title { color: #505070; font-size: 10px; letter-spacing: 2px; text-transform: uppercase; font-weight: bold; }

        /* Scroll Area Fix */
        .terminal-body { 
            padding: 15px; overflow-y: auto; font-size: 13px; flex-grow: 1; 
            scroll-behavior: smooth; -webkit-overflow-scrolling: touch;
        }
        .terminal-body::-webkit-scrollbar { width: 4px; }
        .terminal-body::-webkit-scrollbar-thumb { background: #1a1a2e; border-radius: 10px; }

        .auth-box { max-width: 400px; margin: auto; width: 100%; border: 1px solid #00d2ff; }
        .input-line { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; border-bottom: 1px solid #1a1a2e; padding-bottom: 5px; }
        input { background: transparent; border: none; color: #fff; font-family: 'Fira Code'; outline: none; width: 100%; font-size: 16px; }
        .term-btn { flex: 1; background: transparent; border: 1px solid #00d2ff; color: #00d2ff; padding: 10px; cursor: pointer; font-family: 'Fira Code'; font-size: 11px; transition: 0.3s; border-radius: 4px; }

        .sidebar { display: flex; flex-direction: column; gap: 15px; height: 100%; min-height: 0; }
        .sidebar-box { flex: 1; display: flex; flex-direction: column; min-height: 0; }
        #chat-box { font-size: 11px; line-height: 1.6; color: #a0a0c0; overflow-y: auto; flex-grow: 1; padding: 10px; }
        
        .cmd-line-form, .chat-form { 
            display: flex; width: 100%; background: #080810; padding: 12px; 
            border-top: 1px solid #1a1a2e; align-items: center; flex-shrink: 0;
        }
        .chat-in { font-size: 14px; color: #fff; outline: none; border: none; width: 100%; background: transparent; }
        
        .c-cyan { color: #00d2ff; text-shadow: 0 0 5px #00d2ff; }
        .c-purple { color: #d442f5; text-shadow: 0 0 5px #d442f5; }
        .c-gold { color: #ffbd2e; text-shadow: 0 0 5px #ffbd2e; }
        .c-red { color: #ff5f56; text-shadow: 0 0 5px #ff5f56; }
        .highlight { color: #fff; text-shadow: 0 0 8px #00ff41; }
        .prompt { color: #00d2ff; margin-right: 10px; font-weight: bold; }
        .tx-log { font-size: 11px; margin: 5px 0; padding: 5px; border-left: 2px solid #1a1a2e; background: rgba(255,255,255,0.02); }

        /* Media Query: Responsif untuk HP */
        @media (max-width: 900px) { 
            .main-layout { grid-template-columns: 1fr; grid-template-rows: 1.8fr 1fr; height: 100%; gap: 10px; } 
            .sidebar { flex-direction: row; overflow-x: auto; overflow-y: hidden; }
            .sidebar-box { min-width: 280px; flex: 0 0 auto; height: 100%; }
            body { padding: 5px; }
        }
    </style>
</head>
<body>
    <audio id="sound-success" src="https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3" preload="auto"></audio>
    <audio id="sound-money" src="https://assets.mixkit.co/active_storage/sfx/1614/1614-preview.mp3" preload="auto"></audio>

    <div id="login-screen" class="terminal-container auth-box">
        <div class="terminal-header"><div class="buttons"><span class="dot red"></span><span class="dot yellow"></span><span class="dot green"></span></div><div class="title">VAULT AUTHENTICATION</div></div>
        <div class="terminal-body">
            <div class="input-line"><span>USER</span><input type="text" id="login-user" autocomplete="off"></div>
            <div class="input-line"><span>PASS</span><input type="password" id="login-pass"></div>
            <div id="reg-fields" style="display:none;"><div class="input-line"><span>RE-P</span><input type="password" id="reg-pass-confirm"></div></div>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button id="btn-login" class="term-btn">ACCESS</button>
                <button id="btn-reg-toggle" class="term-btn" style="border-color:#ffbd2e; color:#ffbd2e;">NEW IDENTITY</button>
                <button id="btn-reg-final" class="term-btn" style="display:none;">INITIALIZE</button>
            </div>
        </div>
    </div>

    <div id="main-app" style="display:none;">
        <div class="main-layout">
            <div class="terminal-container">
                <div class="terminal-header">
                    <div class="buttons"><span class="dot red"></span><span class="dot yellow"></span><span class="dot green"></span></div>
                    <div class="title">CORE@VAULT-05 — <span id="display-id" class="c-gold"></span></div>
                </div>
                <div class="terminal-body" id="term-scroll">
                    <div id="history"></div>
                </div>
                <form id="terminal-form" class="cmd-line-form">
                    <span class="prompt">>>></span>
                    <input type="text" id="user-input" autofocus autocomplete="off" spellcheck="false" enterkeyhint="send">
                </form>
            </div>
            <div class="sidebar">
                <div class="terminal-container sidebar-box" style="border-color:#00d2ff">
                    <div class="terminal-header"><div class="title c-cyan">MARKET INDEX</div></div>
                    <div class="terminal-body" style="text-align: center; background: radial-gradient(circle at center, #0a0a1a 0%, #020205 100%);">
                        <div id="vlt-price" style="font-size: 22px; font-weight: bold; margin-bottom: 5px;">Rp1.000</div>
                        <canvas id="marketChart" style="max-height: 80px;"></canvas>
                    </div>
                </div>
                <div class="terminal-container sidebar-box">
                    <div class="terminal-header"><div class="title c-purple">ENCRYPTED CHAT</div></div>
                    <div id="chat-box"></div>
                    <form id="chat-form-box" class="chat-form">
                        <input type="text" id="chat-input" placeholder="Secure transmission..." class="chat-in" enterkeyhint="send">
                    </form>
                </div>
                <div class="terminal-container sidebar-box">
                    <div class="terminal-header"><div class="title">NETWORK NODES</div></div>
                    <div class="terminal-body" id="leaderboard-box" style="font-size:10px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, push, update, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDZe0QP2l2nAjw6qeYUE9wkryMTAnC6N_0",
            databaseURL: "https://vault-blockchain-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        let user = null, mChart, marketPrice = 1000, miningInterval = null;

        const formatN = (num) => Number(num).toLocaleString('id-ID');
        const scrollBottom = () => { const a = document.getElementById('term-scroll'); a.scrollTop = a.scrollHeight; };
        const playS = (id) => document.getElementById(id).play().catch(()=>{});

        const showLoading = (text = "PROCESSING") => {
            return new Promise((resolve) => {
                let pct = 0; const h = document.getElementById('history');
                const l = document.createElement('div'); h.appendChild(l);
                const inv = setInterval(() => {
                    pct += 5; l.innerHTML = `<span class="c-cyan">${text}: [${'#'.repeat(pct/5)}${'.'.repeat(20-pct/5)}] ${pct}%</span>`;
                    scrollBottom(); if (pct >= 100) { clearInterval(inv); l.innerHTML = `<span class="c-cyan">✓ OPERATION COMPLETE</span>`; resolve(); }
                }, 40);
            });
        };

        const printWelcome = () => {
            document.getElementById('history').innerHTML += `<pre class="c-cyan" style="font-size: 8px;">
██╗   ██╗ █████╗ ██╗   ██╗██╗     ████████╗
██║   ██║██╔══██╗██║   ██║██║     ╚══██╔══╝
██║   ██║███████║██║   ██║██║        ██║   
╚██╗ ██╔╝██╔══██║██║   ██║██║        ██║   
 ╚████╔╝ ██║  ██║╚██████╔╝███████╗   ██║   </pre>
            <p class="c-gold">Welcome, ${user.name}. System established. Type <span class="c-cyan">'help'</span> for instruction.</p><hr style="border:1px solid #1a1a2e">`;
            scrollBottom();
        };

        document.getElementById('btn-reg-toggle').onclick = () => {
            document.getElementById('reg-fields').style.display = 'block';
            document.getElementById('btn-login').style.display = 'none';
            document.getElementById('btn-reg-final').style.display = 'block';
        };

        document.getElementById('btn-reg-final').onclick = async () => {
            const u = document.getElementById('login-user').value.trim();
            const p = document.getElementById('login-pass').value;
            const cp = document.getElementById('reg-pass-confirm').value;
            if(!u || !p) return alert("Fill all fields");
            if(p !== cp) return alert("Pass mismatch");
            const snap = await get(ref(db, 'users/'+u));
            if(snap.exists()) return alert("User already exists");
            const id = "VLT-" + Math.random().toString(36).substring(2, 6).toUpperCase();
            await set(ref(db, 'users/'+u), { password:p, id:id, balance:0, vlt_stock:0, is_frozen:false, online:false });
            location.reload();
        };

        document.getElementById('btn-login').onclick = async () => {
            const u = document.getElementById('login-user').value.trim();
            const p = document.getElementById('login-pass').value;
            const snap = await get(ref(db, 'users/'+u));
            if(snap.exists() && snap.val().password === p) {
                user = { name:u, ...snap.val() };
                update(ref(db, `users/${u}`), { online:true });
                onDisconnect(ref(db, `users/${u}`)).update({ online:false });
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                startSystem();
            } else alert("Invalid Credentials");
        };

        function startSystem() {
            document.getElementById('display-id').innerText = user.id;
            printWelcome();

            const ctx = document.getElementById('marketChart').getContext('2d');
            mChart = new Chart(ctx, { 
                type: 'line', 
                data: { labels: Array(20).fill(''), datasets: [{ data: [], borderColor: '#00d2ff', borderWidth: 2, pointRadius: 0, fill: true, backgroundColor: 'rgba(0, 210, 255, 0.05)', tension: 0.4 }] },
                options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false},y:{display:false}} }
            });

            onValue(ref(db, 'users'), (snap) => {
                const data = snap.val(); if(!data) return;
                const sorted = Object.entries(data).sort((a,b) => b[1].balance - a[1].balance);
                document.getElementById('leaderboard-box').innerHTML = sorted.map(([n, d], i) => `
                    <div style="margin-bottom:4px; color:${d.online ? '#00ff41':'#444'}">
                        ${d.online ? '●':'○'} #${i+1} ${n} <span style="float:right; color:#00d2ff">${formatN(d.balance)}</span>
                    </div>`).join('');
                if(user.balance < data[user.name].balance && user.balance !== 0) playS('sound-money');
                user.balance = data[user.name].balance;
                user.vlt_stock = data[user.name].vlt_stock || 0;
                user.is_frozen = data[user.name].is_frozen;
            });

            onValue(ref(db, 'messages'), (snap) => {
                const data = snap.val(); if(!data) return;
                document.getElementById('chat-box').innerHTML = Object.values(data).slice(-15).map(m => {
                    if(m.type === 'private' && (m.to === user.name || m.user === user.name)) return `<div class="c-purple">[PM] ${m.user}: ${m.text}</div>`;
                    if(!m.type) return `<div><span class="c-gold">${m.user}</span>: ${m.text}</div>`;
                    return "";
                }).join('');
                document.getElementById('chat-box').scrollTop = 9999;
            });

            setInterval(() => {
                const old = marketPrice; marketPrice += (Math.random() - 0.47) * 45; if(marketPrice < 100) marketPrice = 100;
                const el = document.getElementById('vlt-price'); el.innerText = `Rp${formatN(marketPrice)}`;
                el.style.color = marketPrice >= old ? "#00ff41" : "#ff5f56";
                mChart.data.datasets[0].data.push(marketPrice);
                mChart.data.datasets[0].borderColor = marketPrice >= old ? "#00ff41" : "#ff5f56";
                if(mChart.data.datasets[0].data.length > 20) mChart.data.datasets[0].data.shift();
                mChart.update('none');
            }, 3000);
        }

        document.getElementById('terminal-form').onsubmit = async (e) => {
            e.preventDefault();
            const inputEl = document.getElementById('user-input');
            const val = inputEl.value.trim(); const pts = val.split(' '); const cmd = pts[0].toLowerCase();
            const hist = document.getElementById('history'); if(!val) return;
            hist.innerHTML += `<div><span class="c-cyan">>>></span> ${val}</div>`; inputEl.value = "";

            if(cmd === 'help') {
                hist.innerHTML += `<div style="border:1px solid #1a1a2e; padding:10px; margin:5px 0; font-size:11px;">
                    <p class="c-cyan">USER: balance, buy [qty], sell [qty], transfer [ID] [AMT], history, /pm [user] [msg], clear</p>
                    ${user.name === "MasterHafiz" ? `<p class="c-gold">MASTER: mine start/stop, deposit [AMT], /freeze [user], /unfreeze [user], sudo_clear_chat, logout_force</p>` : ""}
                </div>`;
            }
            else if(cmd === 'balance') hist.innerHTML += `<p class="c-gold">BALANCE: <span class="highlight">Rp${formatN(user.balance)}</span> | ASSETS: <span class="c-cyan">${user.vlt_stock} VLT</span></p>`;
            else if(cmd === 'clear') { hist.innerHTML = ""; printWelcome(); }
            else if(cmd === 'buy' || cmd === 'sell') {
                const qty = parseInt(pts[1]); const cost = qty * marketPrice;
                if(cmd === 'buy' && user.balance >= cost) {
                    await update(ref(db, `users/${user.name}`), { balance: user.balance - cost, vlt_stock: user.vlt_stock + qty });
                    hist.innerHTML += `<p class="c-cyan">✓ SUCCESS: ACQUIRED ${qty} VLT.</p>`;
                } else if(cmd === 'sell' && user.vlt_stock >= qty) {
                    await update(ref(db, `users/${user.name}`), { balance: user.balance + cost, vlt_stock: user.vlt_stock - qty });
                    hist.innerHTML += `<p class="c-cyan">✓ SUCCESS: LIQUIDATED ${qty} VLT.</p>`;
                } else hist.innerHTML += `<p class="c-red">FAILED: INSUFFICIENT RESOURCES.</p>`;
            }
            else if(cmd === 'transfer') {
                if(user.is_frozen) { hist.innerHTML += `<p class="c-red">ERROR: ACCOUNT IS FROZEN.</p>`; return; }
                const tid = pts[1]?.toUpperCase(); const amt = parseFloat(pts[2]);
                const snap = await get(ref(db, 'users'));
                const targetData = Object.entries(snap.val()).find(([n, d]) => d.id === tid);
                if(targetData && amt > 0 && user.balance >= amt) {
                    await showLoading("ENCRYPTING");
                    await update(ref(db, `users/${user.name}`), { balance: user.balance - amt });
                    await update(ref(db, `users/${targetData[0]}`), { balance: targetData[1].balance + amt });
                    push(ref(db, 'history'), { from: user.name, to: targetData[0], amt, time: new Date().toLocaleTimeString() });
                    playS('sound-success');
                } else hist.innerHTML += `<p class="c-red">TRANSACTION DENIED.</p>`;
            }
            else if(cmd === '/pm') {
                const to = pts[1]; const m = pts.slice(2).join(' ');
                if(to && m) push(ref(db, 'messages'), { user:user.name, to, text:m, type:'private' });
            }
            else if(cmd === 'history') {
                const snap = await get(ref(db, 'history'));
                if(snap.exists()) {
                    hist.innerHTML += `<p class="c-cyan">-- LOGS --</p>`;
                    Object.values(snap.val()).slice(-10).forEach(t => {
                        if(t.from === user.name || t.to === user.name) hist.innerHTML += `<div class="tx-log">[${t.time}] ${t.from} → ${t.to} | Rp${formatN(t.amt)}</div>`;
                    });
                }
            }
            if(user.name === "MasterHafiz") {
                if(cmd === 'deposit') {
                    const amt = parseFloat(pts[1]);
                    const current = await get(ref(db, `users/${user.name}`));
                    await update(ref(db, `users/${user.name}`), { balance: current.val().balance + amt });
                    hist.innerHTML += `<p class="c-gold">MASTER: DEPOSIT Rp${formatN(amt)} CONFIRMED.</p>`;
                }
                else if(cmd === 'mine') {
                    if(pts[1] === 'start') {
                        if(!miningInterval) miningInterval = setInterval(async ()=> {
                            const cur = await get(ref(db, `users/${user.name}`));
                            update(ref(db, `users/${user.name}`), { balance: cur.val().balance + 5000 });
                        }, 3000);
                        hist.innerHTML += `<p class="c-gold">MINING: ACTIVE</p>`;
                    } else { clearInterval(miningInterval); miningInterval=null; hist.innerHTML += `<p class="c-red">MINING: STOPPED</p>`; }
                }
                else if(cmd === '/freeze') { update(ref(db, `users/${pts[1]}`), { is_frozen: true }); hist.innerHTML += `<p class="c-red">FROZEN: ${pts[1]}</p>`; }
                else if(cmd === '/unfreeze') { update(ref(db, `users/${pts[1]}`), { is_frozen: false }); hist.innerHTML += `<p class="c-cyan">RELEASED: ${pts[1]}</p>`; }
                else if(cmd === 'sudo_clear_chat') { await remove(ref(db, 'messages')); hist.innerHTML += `<p class="c-gold">CHAT PURGED.</p>`; }
                else if(cmd === 'logout_force') { update(ref(db, `users/${user.name}`), { online: false }); location.reload(); }
            }
            scrollBottom();
        };

        document.getElementById('chat-form-box').onsubmit = (e) => {
            e.preventDefault();
            const inp = document.getElementById('chat-input');
            if(inp.value) {
                push(ref(db, 'messages'), { user: user.name, text: inp.value });
                inp.value = "";
            }
        };
    </script>
</body>
</html>
